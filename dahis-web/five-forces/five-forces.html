<!DOCTYPE html>
<html lang="tr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <base href="/five-forces/">
  <title>DAHIS: Five Forces ‚Äì Kart Oyunu</title>
  <meta name="description" content="DAHIS: Five Forces ‚Äì stratejik √ßok oyunculu kart oyunu. Karakterini se√ß, puanƒ±nƒ± artƒ±r, rakiplerini alt et.">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700;900&family=Share+Tech+Mono&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="/styles.css">
  <link rel="stylesheet" href="five-forces.css">
</head>
<body class="lobby-page">
  <div id="nav-placeholder"></div>

  <!-- ‚îÄ‚îÄ Hero ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ -->
  <header class="lobby-header">
    <a href="/" class="back-home" data-i18n="lobby.back">‚Üê dahis.io</a>

    <!-- Lang switcher -->
    <div class="lang-switcher">
      <button class="lang-btn" data-lang="tr">TR</button>
      <button class="lang-btn" data-lang="en">EN</button>
    </div>

    <div class="logo-block">
      <div class="logo-glyph">‚ö°</div>
      <h1 class="lobby-title"><span>Five Forces</span></h1>
      <p class="lobby-subtitle" data-i18n="lobby.subtitle">Strategic ¬∑ Turn-based ¬∑ Card Game</p>
    </div>
  </header>

  <!-- ‚îÄ‚îÄ Steps ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ -->
  <main class="lobby-main">

    <!-- Step 0: Play mode ‚Äì sekmeler (Yerel | √áevrimi√ßi) -->
    <section class="lobby-step lobby-step-mode" id="step-mode">
      <h2 class="step-title">
        <span class="step-num">00</span>
        <span data-i18n="lobby.mode.title">How do you want to play?</span>
      </h2>
      <div class="mode-tabs" role="tablist">
        <button type="button" class="mode-tab active" id="btn-mode-local" role="tab" aria-selected="true" data-mode="local">
          <span class="mode-tab-icon">üì±</span>
          <span data-i18n="lobby.mode.local">Local</span>
        </button>
        <button type="button" class="mode-tab" id="btn-mode-online" role="tab" aria-selected="false" data-mode="online">
          <span class="mode-tab-icon">üåê</span>
          <span data-i18n="lobby.mode.online">Online</span>
        </button>
      </div>
      <p class="step-note" id="online-config-note" style="display:none;" data-i18n="lobby.mode.online_config">Configure Firebase in ff-config.js to play online.</p>

      <!-- Online panel: √ºstte butonlar, altta sadece odalar -->
      <div class="mode-tab-panel" id="mode-panel-online" role="tabpanel" hidden>
      <div class="online-top-actions">
        <button type="button" class="btn-online-top" id="btn-new-room" data-i18n="lobby.online.new_room">New room</button>
        <button type="button" class="btn-online-top" id="btn-search-code" data-i18n="lobby.online.search_code">Search by code</button>
      </div>

      <!-- Ana g√∂r√ºn√ºm: sadece oda listesi -->
      <div id="online-rooms-view">
        <div class="room-list-actions">
          <button type="button" class="btn-refresh-rooms" id="btn-refresh-rooms" data-i18n="lobby.online.refresh">Refresh</button>
        </div>
        <ul id="room-list" class="room-list"></ul>
        <p class="room-list-empty hidden" id="room-list-empty" data-i18n="lobby.online.no_rooms">No rooms yet. Create one!</p>
      </div>

      <!-- Yeni oda olu≈ütur formu (gizli) -->
      <div id="online-create-block" class="hidden">
        <button type="button" class="btn-back" id="btn-create-back" data-i18n="lobby.online.back">‚Üê Back</button>
        <label class="online-label" data-i18n="lobby.online.your_name">Your name</label>
        <input type="text" id="online-create-name" class="player-name-input" maxlength="20" placeholder="" data-i18n-placeholder="lobby.player.placeholder">
        <label class="online-label" data-i18n="lobby.online.room_password_optional">Room password (optional)</label>
        <input type="password" id="online-create-password" class="player-name-input" maxlength="20" placeholder="" data-i18n-placeholder="lobby.online.room_password_placeholder" autocomplete="off">
        <button type="button" class="btn-start" id="btn-do-create-room" data-i18n="lobby.online.do_create">Create room</button>
      </div>

      <!-- Oda kodu arat (gizli) -->
      <div id="online-join-by-code" class="hidden">
        <button type="button" class="btn-back" id="btn-join-back" data-i18n="lobby.online.back">‚Üê Back</button>
        <label class="online-label" data-i18n="lobby.online.room_code">Room code (6 characters)</label>
        <input type="text" id="online-join-code" class="player-name-input room-code-input" maxlength="6" placeholder="ABC123" style="text-transform:uppercase;">
        <button type="button" class="btn-online-choice" id="btn-do-join-fetch">OK</button>
        <div id="online-join-password" class="hidden">
          <label class="online-label" data-i18n="lobby.online.room_password_required">Room password</label>
          <input type="password" id="online-join-password-input" class="player-name-input" maxlength="20" placeholder="" autocomplete="off">
          <button type="button" class="btn-online-choice" id="btn-join-password-ok" data-i18n="lobby.online.continue">Continue</button>
        </div>
        <div id="online-join-after" class="hidden">
          <label class="online-label" data-i18n="lobby.online.your_name">Your name</label>
          <input type="text" id="online-join-name" class="player-name-input" maxlength="20">
          <button type="button" class="btn-start" id="btn-do-join-room" data-i18n="lobby.online.do_join">Join room</button>
        </div>
      </div>

      <!-- Room waiting: code + link + players + Start (host only) -->
      <div id="online-room-waiting" class="hidden">
        <p class="room-code-line"><span data-i18n="lobby.online.room_code">Room code</span>: <strong id="room-code-display"></strong></p>
        <p class="room-link-line"><span data-i18n="lobby.online.share">Share link</span>: <input type="text" id="room-link-input" readonly class="room-link-input"> <button type="button" class="btn-copy-link" id="btn-copy-link" data-i18n="lobby.online.copy">Copy</button></p>
        <h3 class="room-players-title" data-i18n="lobby.online.players">Players in room</h3>
        <ul id="room-players-list" class="room-players-list"></ul>
        <p class="room-waiting-msg" id="room-waiting-msg" data-i18n="lobby.online.waiting">Waiting for host to start‚Ä¶</p>
        <button type="button" class="btn-start hidden" id="btn-online-start" data-i18n="lobby.btn.start">Start Game ‚Üí</button>
        <button type="button" class="btn-leave-room" id="btn-leave-room" data-i18n="lobby.online.leave">Leave room</button>
      </div>
      </div><!-- /mode-panel-online -->

    </section>

    <!-- Yerel sekme i√ßeriƒüi -->
    <div class="mode-tab-panel" id="mode-panel-local" role="tabpanel">
    <!-- Step 1: Player count (local only) -->
    <section class="lobby-step hidden" id="step-count">
      <h2 class="step-title">
        <span class="step-num">01</span>
        <span data-i18n="lobby.step1.title">How many players?</span>
      </h2>
      <div class="count-grid">
        <button class="count-btn" data-count="1">1 + AI</button>
        <button class="count-btn" data-count="2">2 + AI</button>
        <button class="count-btn" data-count="3">3</button>
        <button class="count-btn" data-count="4">4</button>
        <button class="count-btn" data-count="5">5</button>
      </div>
      <p class="step-note" data-i18n="lobby.step1.note">Non-human slots filled by AI.</p>
      <p class="step-note step-note-how" data-i18n="lobby.step1.how">Play on one device. Human players take turns on the same screen; AI plays automatically when it‚Äôs their turn.</p>
    </section>

    <!-- Step 2: Player names -->
    <section class="lobby-step hidden" id="step-players">
      <h2 class="step-title">
        <span class="step-num">02</span>
        <span data-i18n="lobby.step2.title">Name your players</span>
      </h2>
      <div id="player-forms"></div>
    </section>

    <!-- Step 3: Character selection -->
    <section class="lobby-step hidden" id="step-characters">
      <h2 class="step-title">
        <span class="step-num">03</span>
        <span data-i18n="lobby.step3.title">Choose characters</span>
      </h2>
      <p class="step-note" id="char-turn-label"></p>
      <div class="char-grid" id="char-grid"></div>
    </section>

    <!-- Step 4: Review & start -->
    <section class="lobby-step hidden" id="step-review">
      <h2 class="step-title">
        <span class="step-num">04</span>
        <span data-i18n="lobby.step4.title">Ready to play?</span>
      </h2>
      <div id="review-list" class="review-list"></div>
      <button class="btn-start" id="btn-start" data-i18n="lobby.btn.start">Start Game ‚Üí</button>
    </section>
    </div><!-- /mode-panel-local -->

  </main>

  <!-- ‚îÄ‚îÄ Card preview ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ -->
  <section class="deck-preview">
    <h2 class="section-title" data-i18n="lobby.deck.title">The 40-Card Deck</h2>
    <div class="deck-legend">
      <div class="legend-item legend-score">
        <span data-i18n="lobby.legend.score">Score Cards</span> <span>16</span>
      </div>
      <div class="legend-item legend-risk">
        <span data-i18n="lobby.legend.risk">Risk Cards</span> <span>8</span>
      </div>
      <div class="legend-item legend-action">
        <span data-i18n="lobby.legend.action">Action Cards</span> <span>10</span>
      </div>
      <div class="legend-item legend-chaos">
        <span data-i18n="lobby.legend.chaos">Chaos Cards</span> <span>6</span>
      </div>
    </div>
  </section>

  <!-- ‚îÄ‚îÄ Rules summary ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ -->
  <section class="rules-block">
    <h2 class="section-title" data-i18n="lobby.rules.title">How to Play</h2>
    <ol class="rules-list">
      <li data-i18n="lobby.rules.1" data-i18n-html="true"><strong>Draw</strong> a card from the deck.</li>
      <li data-i18n="lobby.rules.2" data-i18n-html="true"><strong>Play</strong> one card from your hand.</li>
      <li data-i18n="lobby.rules.3" data-i18n-html="true">Optionally <strong>use your character ability</strong> (once per turn).</li>
      <li data-i18n="lobby.rules.4" data-i18n-html="true"><strong>End your turn.</strong> Hand limit: 7 cards.</li>
    </ol>
    <p class="rules-note" data-i18n="lobby.rules.note1">Game ends when the deck is empty or 12 rounds pass. Highest score wins.</p>
    <p class="rules-note" data-i18n="lobby.rules.note2" data-i18n-html="true"><strong>‚öîÔ∏è Betrayal Token</strong> ‚Äì cancel an opponent's card instantly.</p>
  </section>

  <div id="footer-placeholder"></div>

  <!-- Scripts: i18n first, then game modules; Firebase for online rooms -->
  <script src="load-nav-footer.js"></script>
  <script src="i18n.js"></script>
  <script src="characters.js"></script>
  <script src="deck.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
  <script src="ff-config.js"></script>
  <script src="ff-rooms.js"></script>
  <script src="game.js"></script>
  <script>
  (function () {
    var CHAR_IDS = Object.keys(CHARACTERS);
    var humanCount = 0;
    var playerDrafts = [];
    var assignments = [];
    var charPickIdx = 0;
    var takenChars = [];

    // ‚îÄ‚îÄ Step 1: count ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    document.querySelectorAll('.count-btn').forEach(function (btn) {
      btn.addEventListener('click', function () {
        document.querySelectorAll('.count-btn').forEach(function(b){ b.classList.remove('selected'); });
        btn.classList.add('selected');
        humanCount = parseInt(btn.dataset.count, 10);
        buildPlayerForms(humanCount);
        showStep('step-players');
      });
    });

    // Re-render dynamic content on language switch
    document.addEventListener('langchange', function () {
      // Rebuild char grid if visible (player labels / ability text update)
      var charStep = document.getElementById('step-characters');
      if (charStep && !charStep.classList.contains('hidden') && charPickIdx < assignments.length) {
        buildCharGrid();
      }
    });

    function buildPlayerForms(n) {
      var el = document.getElementById('player-forms');
      var html = '';
      for (var i = 0; i < n; i++) {
        html += '<div class="player-form">' +
          '<label>' + t('lobby.player.label', { n: i + 1 }) + '</label>' +
          '<input class="player-name-input" data-idx="' + i + '" type="text"' +
            ' placeholder="' + escHtml(t('lobby.player.placeholder')) + '" maxlength="16">' +
        '</div>';
      }
      html += '<button class="btn-next" id="btn-names-next">' + t('lobby.btn.next') + '</button>';
      el.innerHTML = html;

      document.getElementById('btn-names-next').addEventListener('click', function () {
        playerDrafts = [];
        var formContainer = document.getElementById('player-forms');
        var inputs = formContainer ? formContainer.querySelectorAll('.player-name-input') : [];
        for (var i = 0; i < inputs.length; i++) {
          var v = inputs[i].value.trim() || t('lobby.player.label', { n: i + 1 });
          playerDrafts.push({ name: v, isAI: false });
        }
        var aiNeeded = Math.max(0, 3 - humanCount);
        for (var a = 0; a < aiNeeded; a++) {
          playerDrafts.push({ name: 'AI-' + (a + 1), isAI: true });
        }
        assignments = playerDrafts.map(function(p){ return { name: p.name, isAI: p.isAI, characterId: null }; });
        takenChars = [];
        charPickIdx = 0;
        buildCharGrid();
        showStep('step-characters');
      });
    }

    // ‚îÄ‚îÄ Step 3: character pick ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    function buildCharGrid() {
      var grid = document.getElementById('char-grid');
      var label = document.getElementById('char-turn-label');

      while (charPickIdx < assignments.length && assignments[charPickIdx].isAI) {
        var available = CHAR_IDS.filter(function(id){ return takenChars.indexOf(id) === -1; });
        if (available.length === 0) break;
        var pick = available[Math.floor(Math.random() * available.length)];
        assignments[charPickIdx].characterId = pick;
        takenChars.push(pick);
        charPickIdx++;
      }

      if (charPickIdx >= assignments.length) {
        buildReview();
        showStep('step-review');
        return;
      }

      label.textContent = t('lobby.step3.pick', { name: assignments[charPickIdx].name });

      grid.innerHTML = CHAR_IDS.map(function (cid) {
        var c = CHARACTERS[cid];
        var taken = takenChars.indexOf(cid) !== -1;
        var avatarHtml = c.image
            ? '<div class="char-avatar"><img src="' + c.image + '" alt=""></div>'
            : '<div class="char-avatar" style="background:' + c.gradient + '">' + c.emoji + '</div>';
        return '<div class="char-card' + (taken ? ' taken' : '') + '" data-cid="' + cid + '">' +
          avatarHtml +
          '<h3>' + c.name + '</h3>' +
          '<p class="char-title-sub">' + c.title + '</p>' +
          '<div class="char-ability">' +
            '<span class="ability-label">' + c.ability.name + '</span>' +
            '<p>' + c.ability.desc + '</p>' +
          '</div>' +
          (taken ? '<div class="taken-badge">' + t('lobby.taken') + '</div>' : '') +
        '</div>';
      }).join('');

      grid.querySelectorAll('.char-card:not(.taken)').forEach(function (el) {
        el.addEventListener('click', function () {
          assignments[charPickIdx].characterId = el.dataset.cid;
          takenChars.push(el.dataset.cid);
          charPickIdx++;
          buildCharGrid();
        });
      });
    }

    // ‚îÄ‚îÄ Step 4: review ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    function buildReview() {
      var el = document.getElementById('review-list');
      var startBtn = document.getElementById('btn-start');
      if (startBtn) startBtn.textContent = t('lobby.btn.start');

      el.innerHTML = assignments.map(function (a) {
        var chr = CHARACTERS[a.characterId];
        var reviewAvatar = chr.image
          ? '<div class="review-avatar"><img src="' + chr.image + '" alt=""></div>'
          : '<div class="review-avatar" style="background:' + chr.gradient + '">' + chr.emoji + '</div>';
        return '<div class="review-row">' +
          reviewAvatar +
          '<div class="review-info">' +
            '<strong>' + escHtml(a.name) + '</strong>' +
            (a.isAI ? ' <span class="ai-badge">AI</span>' : '') +
            '<span>' + chr.name + ' ‚Äì ' + chr.ability.name + '</span>' +
          '</div>' +
        '</div>';
      }).join('');
    }

    document.getElementById('btn-start').addEventListener('click', function () {
      var humanIdx = assignments.findIndex(function(a){ return !a.isAI; });
      if (humanIdx === -1) humanIdx = 0;
      sessionStorage.setItem('ffSession', JSON.stringify({
        players: assignments,
        humanIdx: humanIdx,
        lang: I18n.getLang()
      }));
      window.location.href = '/five-forces/game';
    });

    // ‚îÄ‚îÄ Util ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    function showStep(id) {
      var localPanel = document.getElementById('mode-panel-local');
      if (localPanel) {
        localPanel.querySelectorAll('.lobby-step').forEach(function (s) { s.classList.add('hidden'); });
      }
      var el = document.getElementById(id);
      if (el) { el.classList.remove('hidden'); el.scrollIntoView({ behavior: 'smooth', block: 'start' }); }
    }

    function setModeTab(mode) {
      var localTab = document.getElementById('btn-mode-local');
      var onlineTab = document.getElementById('btn-mode-online');
      var localPanel = document.getElementById('mode-panel-local');
      var onlinePanel = document.getElementById('mode-panel-online');
      localTab.classList.toggle('active', mode === 'local');
      localTab.setAttribute('aria-selected', mode === 'local' ? 'true' : 'false');
      onlineTab.classList.toggle('active', mode === 'online');
      onlineTab.setAttribute('aria-selected', mode === 'online' ? 'true' : 'false');
      if (localPanel) {
        localPanel.hidden = mode !== 'local';
      }
      if (onlinePanel) {
        onlinePanel.hidden = mode !== 'online';
      }
    }

    function escHtml(s) {
      return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');
    }

    // ‚îÄ‚îÄ Play mode: Local vs Online ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    var onlineRoomId = null;
    var onlineIsHost = false;
    var onlineMySlotIndex = 0;

    /** √áevrimi√ßi panelde hangi g√∂r√ºn√ºm: rooms | create | join-by-code | room-waiting */
    function showOnlineView(which) {
      var roomsView = document.getElementById('online-rooms-view');
      var create = document.getElementById('online-create-block');
      var joinCode = document.getElementById('online-join-by-code');
      var waiting = document.getElementById('online-room-waiting');
      if (roomsView) roomsView.classList.add('hidden');
      if (create) create.classList.add('hidden');
      if (joinCode) joinCode.classList.add('hidden');
      if (waiting) waiting.classList.add('hidden');
      if (which === 'rooms' && roomsView) { roomsView.classList.remove('hidden'); refreshRoomList(); }
      if (which === 'create' && create) create.classList.remove('hidden');
      if (which === 'join-by-code' && joinCode) {
        joinCode.classList.remove('hidden');
        document.getElementById('online-join-after').classList.add('hidden');
        document.getElementById('online-join-password').classList.add('hidden');
      }
      if (which === 'room-waiting' && waiting) waiting.classList.remove('hidden');
    }

    function refreshRoomList() {
      var listEl = document.getElementById('room-list');
      var emptyEl = document.getElementById('room-list-empty');
      if (!listEl || !window.FFRooms || !window.FFRooms.listRooms) return;
      listEl.innerHTML = '';
      listEl.classList.add('loading');
      window.FFRooms.listRooms().then(function (rooms) {
        listEl.classList.remove('loading');
        if (emptyEl) emptyEl.classList.toggle('hidden', rooms.length > 0);
        rooms.forEach(function (r) {
          var li = document.createElement('li');
          li.className = 'room-list-item';
          var hostName = escHtml(r.hostName || '');
          var count = (r.players && r.players.length) || 0;
          var lock = r.hasPassword ? ' <span class="room-list-lock" title="' + (t('lobby.online.room_has_password') || 'Password protected') + '">üîí</span>' : '';
          li.innerHTML = '<span class="room-list-code">' + escHtml(r.code) + lock + '</span>' +
            '<span class="room-list-meta">' + hostName + ' ¬∑ ' + count + '/5</span>' +
            '<button type="button" class="btn-join-room-item" data-code="' + escHtml(r.code) + '">' + (t('lobby.online.do_join') || 'Join') + '</button>';
          listEl.appendChild(li);
          li.querySelector('.btn-join-room-item').addEventListener('click', function () {
            tryJoinWithCode(r.code, r.hasPassword);
          });
        });
      }).catch(function () {
        listEl.classList.remove('loading');
        if (emptyEl) emptyEl.classList.remove('hidden');
      });
    }

    var pendingJoinPassword = '';

    function tryJoinWithCode(code, hasPasswordFromList) {
      code = String(code).toUpperCase().replace(/\s/g, '');
      if (!code || code.length !== 6) return;
      showOnlineView('join-by-code');
      document.getElementById('online-join-code').value = code;
      document.getElementById('online-join-password').classList.add('hidden');
      document.getElementById('online-join-after').classList.add('hidden');
      document.getElementById('online-join-password-input').value = '';
      pendingJoinPassword = '';
      window.FFRooms.getRoom(code).then(function (room) {
        if (!room) { alert(t('lobby.online.room_not_found') || 'Room not found'); return; }
        if (room.hasPassword || hasPasswordFromList) {
          document.getElementById('online-join-password').classList.remove('hidden');
          document.getElementById('btn-join-password-ok').onclick = function () {
            pendingJoinPassword = (document.getElementById('online-join-password-input').value || '').trim();
            document.getElementById('online-join-password').classList.add('hidden');
            showJoinNameAndChar(code);
          };
          return;
        }
        showJoinNameAndChar(code);
      }).catch(function (err) {
        alert(err && (err.message || String(err)) || (t('lobby.online.room_not_found') || 'Room not found'));
      });
    }

    function showJoinNameAndChar(code) {
      document.getElementById('online-join-after').classList.remove('hidden');
      document.getElementById('online-join-name').value = '';
      document.getElementById('btn-do-join-room').onclick = function () {
        var name = (document.getElementById('online-join-name').value || '').trim() || 'Player';
        window.FFRooms.joinRoom(code, name, pendingJoinPassword).then(function (res) {
          onlineRoomId = res.roomId;
          onlineIsHost = false;
          onlineMySlotIndex = res.mySlotIndex;
          document.getElementById('room-code-display').textContent = code;
          document.getElementById('room-link-input').value = '';
          showOnlineView('room-waiting');
          document.getElementById('btn-online-start').classList.add('hidden');
          document.getElementById('room-waiting-msg').classList.remove('hidden');
          window.FFRooms.subscribeRoom(res.roomId, function (data) {
            if (!data) return;
            var list = document.getElementById('room-players-list');
            if (list) list.innerHTML = (data.players || []).map(function (p) { return '<li>' + escHtml(p.name) + (p.characterId && CHARACTERS[p.characterId] ? ' ‚Äì ' + CHARACTERS[p.characterId].name : '') + '</li>'; }).join('');
            if (data.status === 'playing' && data.gameState) goToGameWithRoom(onlineRoomId, data.gameState, onlineMySlotIndex);
          });
        }).catch(function (err) { alert(err.message || 'Join failed'); });
      };
    }

    function goToGameWithRoom(roomId, gameState, humanIdx) {
      sessionStorage.setItem('ffSession', JSON.stringify({
        roomId: roomId,
        gameState: gameState,
        humanIdx: humanIdx,
        lang: I18n.getLang(),
        isOnline: true
      }));
      window.location.href = '/five-forces/game';
    }

    function buildSingleCharGrid(containerId, selectedCid, onSelect) {
      var container = document.getElementById(containerId);
      if (!container) return;
      container.innerHTML = CHAR_IDS.map(function (cid) {
        var c = CHARACTERS[cid];
        var sel = selectedCid === cid ? ' selected' : '';
        var avatarHtml = c.image ? '<div class="char-avatar"><img src="' + c.image + '" alt=""></div>' : '<div class="char-avatar" style="background:' + c.gradient + '">' + c.emoji + '</div>';
        return '<div class="char-card' + sel + '" data-cid="' + cid + '">' + avatarHtml + '<h3>' + c.name + '</h3></div>';
      }).join('');
      container.querySelectorAll('.char-card').forEach(function (el) {
        el.addEventListener('click', function () {
          container.querySelectorAll('.char-card').forEach(function (c) { c.classList.remove('selected'); });
          el.classList.add('selected');
          if (onSelect) onSelect(el.dataset.cid);
        });
      });
    }

    document.getElementById('btn-mode-local').addEventListener('click', function () {
      setModeTab('local');
      document.getElementById('online-config-note').style.display = 'none';
      ['online-rooms-view', 'online-create-block', 'online-join-by-code', 'online-room-waiting'].forEach(function (id) {
        var el = document.getElementById(id);
        if (el) el.classList.add('hidden');
      });
      showStep('step-count');
    });

    document.getElementById('btn-mode-online').addEventListener('click', function () {
      setModeTab('online');
      if (!window.FFRooms || !window.FFRooms.isAvailable()) {
        document.getElementById('online-config-note').style.display = 'block';
        return;
      }
      document.getElementById('online-config-note').style.display = 'none';
      showOnlineView('rooms');
    });

    document.getElementById('btn-new-room').addEventListener('click', function () {
      showOnlineView('create');
      document.getElementById('online-create-name').value = '';
      document.getElementById('online-create-password').value = '';
      document.getElementById('btn-do-create-room').onclick = function () {
        var name = (document.getElementById('online-create-name').value || '').trim() || 'Host';
        var pwd = (document.getElementById('online-create-password').value || '').trim() || null;
        window.FFRooms.createRoom(name, pwd).then(function (res) {
          onlineRoomId = res.roomId;
          onlineIsHost = true;
          onlineMySlotIndex = 0;
          document.getElementById('room-code-display').textContent = res.code;
          document.getElementById('room-link-input').value = window.location.origin + '/five-forces/?join=' + res.code;
          showOnlineView('room-waiting');
          document.getElementById('btn-online-start').classList.remove('hidden');
          document.getElementById('room-waiting-msg').classList.remove('hidden');
          window.FFRooms.subscribeRoom(res.roomId, function (data) {
            if (!data) return;
            var list = document.getElementById('room-players-list');
            if (list) list.innerHTML = (data.players || []).map(function (p) { return '<li>' + escHtml(p.name) + (p.characterId && CHARACTERS[p.characterId] ? ' ‚Äì ' + CHARACTERS[p.characterId].name : '') + '</li>'; }).join('');
            if (data.status === 'playing' && data.gameState) goToGameWithRoom(res.roomId, data.gameState, 0);
          });
        }).catch(function (err) { alert(err.message || 'Failed to create room'); });
      };
    });

    document.getElementById('btn-create-back').addEventListener('click', function () {
      showOnlineView('rooms');
    });

    document.getElementById('btn-search-code').addEventListener('click', function () {
      showOnlineView('join-by-code');
      document.getElementById('online-join-code').value = '';
    });

    document.getElementById('btn-join-back').addEventListener('click', function () {
      showOnlineView('rooms');
    });

    document.getElementById('btn-refresh-rooms').addEventListener('click', function () {
      refreshRoomList();
    });

    document.getElementById('btn-do-join-fetch').addEventListener('click', function () {
      var code = (document.getElementById('online-join-code').value || '').toUpperCase().replace(/\s/g, '');
      if (code.length !== 6) { alert(t('lobby.online.invalid_code') || 'Enter 6-character code'); return; }
      tryJoinWithCode(code);
    });

    document.getElementById('btn-online-start').addEventListener('click', function () {
      if (!onlineRoomId || !onlineIsHost || !window.FFRooms) return;
      window.FFRooms.init().then(function () {
        var ref = window.firebase.firestore().collection('ff_rooms').doc(onlineRoomId);
        ref.get().then(function (snap) {
          var data = snap.exists ? snap.data() : null;
          if (!data || !data.players || data.players.length < 2) {
            alert(t('lobby.online.min_players') || 'At least 2 players to start.');
            return;
          }
          var players = data.players.map(function (p) { return { name: (p.name || '').trim() || ('Player'), characterId: p.characterId || null, isAI: false }; });
          Game.init(players);
          var full = Game.getFullState && Game.getFullState();
          if (!full) return;
          window.FFRooms.startGame(onlineRoomId, full).then(function () { goToGameWithRoom(onlineRoomId, full, 0); });
        });
      });
    });

    document.getElementById('btn-leave-room').addEventListener('click', function () {
      if (onlineRoomId && window.FFRooms) window.FFRooms.leaveRoom(onlineRoomId);
      onlineRoomId = null;
      showOnlineView('rooms');
      document.getElementById('btn-online-start').classList.add('hidden');
      document.getElementById('room-waiting-msg').classList.remove('hidden');
    });

    document.getElementById('btn-copy-link').addEventListener('click', function () {
      var input = document.getElementById('room-link-input');
      if (input) { input.select(); try { document.execCommand('copy'); } catch (e) {} }
    });

    showStep('step-mode');
    setModeTab('local');
  })();
  </script>
</body>
</html>

<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>dahiOS Tag Detay</title>
    <link rel="icon" type="image/png" href="favicon.png">
    <link rel="apple-touch-icon" href="favicon.png">
    <link rel="stylesheet" href="styles.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;700;800&display=swap" rel="stylesheet">
    
    <!-- Google AdSense -->
    <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-2672908385908922"
     crossorigin="anonymous"></script>
    <script>
        // AdSense reklamlarƒ±nƒ± ba≈ülat (sadece bir kez, hata kontrol√º ile)
        (function() {
            var adsInitialized = false;
            
            // AdSense 400 hatalarƒ±nƒ± console'da gizle (hesap onayƒ± beklenirken normal)
            var originalError = console.error;
            console.error = function() {
                var args = Array.prototype.slice.call(arguments);
                var errorStr = args.join(' ');
                // AdSense 400 hatalarƒ±nƒ± gizle
                if (errorStr.includes('ads?client=ca-pub-') && errorStr.includes('400')) {
                    return; // Bu hatayƒ± g√∂sterme
                }
                originalError.apply(console, args);
            };
            
            function initAds() {
                if (adsInitialized) return;
                
                // AdSense script y√ºklenmi≈ü mi kontrol et
                if (!window.adsbygoogle) {
                    // Script hen√ºz y√ºklenmemi≈ü, bekle
                    setTimeout(initAds, 200);
                    return;
                }
                
                var ads = document.querySelectorAll('.adsbygoogle');
                if (ads.length === 0) return;
                
                ads.forEach(function(ad) {
                    if (ad.innerHTML.trim() !== '') return;
                    
                    try {
                        (adsbygoogle = window.adsbygoogle || []).push({});
                    } catch (e) {
                        // Hatalarƒ± sessizce ignore et (AdSense hesap onayƒ± beklenirken normal)
                        if (e.message && !e.message.includes('already have ads')) {
                            // Sessizce devam et
                        }
                    }
                });
                adsInitialized = true;
            }
            
            if (document.readyState === 'complete' || document.readyState === 'interactive') {
                setTimeout(initAds, 1000);
            } else {
                window.addEventListener('load', function() {
                    setTimeout(initAds, 1000);
                });
            }
        })();
    </script>
    <style>
        .tag-detail-container {
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: #fff;
        }
        .tag-content {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 40px;
            max-width: 500px;
            width: 100%;
            text-align: center;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        .loading {
            text-align: center;
            padding: 40px;
        }
        .error {
            color: #ff4444;
            text-align: center;
            padding: 40px;
        }
        .adsense-container {
            width: 100%;
            max-width: 500px;
            margin: 20px auto;
            text-align: center;
        }
        .adsense-top {
            margin-bottom: 20px;
        }
        .adsense-bottom {
            margin-top: 20px;
        }
        @media (max-width: 768px) {
            .adsense-container {
                padding: 0 10px;
            }
        }
    </style>
</head>
<body>
    <!-- AdSense Banner - Top -->
    <div class="adsense-container adsense-top">
        <ins class="adsbygoogle"
             style="display:block"
             data-ad-client="ca-pub-2672908385908922"
             data-ad-slot="2251888532"
             data-ad-format="auto"
             data-full-width-responsive="true"></ins>
    </div>

    <div class="tag-detail-container">
        <div id="tagContent" class="tag-content">
            <div class="loading">
                <p>Y√ºkleniyor...</p>
            </div>
        </div>
    </div>

    <!-- AdSense Banner - Bottom -->
    <div class="adsense-container adsense-bottom">
        <ins class="adsbygoogle"
             style="display:block"
             data-ad-client="ca-pub-2672908385908922"
             data-ad-slot="2251888532"
             data-ad-format="auto"
             data-full-width-responsive="true"></ins>
    </div>

    <script>
        // URL parametrelerinden bilgileri al
        const urlParams = new URLSearchParams(window.location.search);
        const dahiosId = urlParams.get('dahiosId') || urlParams.get('nfcId');
        const isActive = urlParams.get('isActive') === 'true';
        const characterId = urlParams.get('characterId') || '';
        const profileLinkTypesStr = urlParams.get('profileLinkTypes');
        const userDataStr = urlParams.get('userData');

        if (!dahiosId) {
            document.getElementById('tagContent').innerHTML = `
                <div class="error">
                    <h2>Hata</h2>
                    <p>dahiOS ID bulunamadƒ±.</p>
                    <a href="index.html" style="color: #fff; text-decoration: underline;">Ana Sayfaya D√∂n</a>
                </div>
            `;
        } else {
            // URL parametrelerinden tag bilgilerini olu≈ütur
            const tagData = {
                dahiosId: dahiosId,
                isActive: isActive,
                characterId: characterId,
                profileLinkTypes: profileLinkTypesStr,
                userData: userDataStr
            };
            
            // Direkt render et
            renderTagContent(tagData);
        }

        // Tag bilgilerini HTML olarak render et
        function renderTagContent(tagData) {
            const contentDiv = document.getElementById('tagContent');
            
            // Pasif tag durumu
            if (!tagData.isActive) {
                const characterId = tagData.characterId || "unknown";
                const characterName = characterId.charAt(0).toUpperCase() + characterId.slice(1);
                
                contentDiv.innerHTML = `
                    <div class="icon" style="font-size: 64px; margin-bottom: 20px; opacity: 0.8;">‚è∏Ô∏è</div>
                    <h1 style="font-size: 28px; margin-bottom: 16px; font-weight: 700;">Bu dahiOS Cihazƒ± ≈ûu Anda Pasif</h1>
                    <p style="font-size: 16px; line-height: 1.6; margin-bottom: 24px; opacity: 0.9;">
                        <span style="font-weight: 600; color: #ffd700;">${characterName}</span> karakterine
                        ait dahiOS cihazƒ± ≈üu anda aktif deƒüil.
                    </p>
                    <p style="font-size: 16px; line-height: 1.6; margin-bottom: 24px; opacity: 0.9;">
                        Cihazƒ± aktif hale getirmek i√ßin l√ºtfen cihaz sahibiyle ileti≈üime
                        ge√ßin veya dahi's uygulamasƒ±ndan cihazƒ± y√∂netin.
                    </p>
                    <a href="https://dahis.io" style="display: inline-block; background: rgba(255, 255, 255, 0.2); color: #fff; padding: 12px 24px; border-radius: 25px; text-decoration: none; font-weight: 600; transition: all 0.3s ease; border: 1px solid rgba(255, 255, 255, 0.3);">dahi's Ana Sayfaya D√∂n</a>
                    <div style="margin-top: 32px; font-size: 12px; opacity: 0.7;">
                        dahi's One ¬© 2025
                    </div>
                `;
                return;
            }

            // Aktif tag - profil linkleri varsa g√∂ster
            let profileLinkTypes = null;
            if (tagData.profileLinkTypes) {
                try {
                    profileLinkTypes = typeof tagData.profileLinkTypes === 'string' 
                        ? JSON.parse(tagData.profileLinkTypes) 
                        : tagData.profileLinkTypes;
                } catch (e) {
                    profileLinkTypes = tagData.profileLinkTypes;
                }
            } else if (tagData.profileLinkType) {
                profileLinkTypes = [tagData.profileLinkType];
            }
            
            let userData = null;
            if (tagData.userData) {
                try {
                    userData = typeof tagData.userData === 'string' 
                        ? JSON.parse(tagData.userData) 
                        : tagData.userData;
                } catch (e) {
                    userData = tagData.userData;
                }
            } else if (tagData.user) {
                userData = tagData.user;
            }
            
            if (profileLinkTypes && profileLinkTypes.length > 0 && userData) {
                // Karakter renk kodlarƒ±
                const characterColors = {
                    "puls": {primary: "#ff4444", secondary: "#cc3333"},
                    "zest": {primary: "#ff8844", secondary: "#cc6633"},
                    "lumo": {primary: "#ffdd44", secondary: "#ccaa33"},
                    "vigo": {primary: "#44dd88", secondary: "#33aa66"},
                    "aura": {primary: "#4488ff", secondary: "#3366cc"},
                };
                
                const characterId = tagData.characterId || "puls";
                const charColor = characterColors[characterId] || characterColors["puls"];
                
                // Body background rengini deƒüi≈ütir
                document.querySelector('.tag-detail-container').style.background = 
                    `linear-gradient(135deg, ${charColor.primary} 0%, ${charColor.secondary} 100%)`;
                
                // Profil linklerini olu≈ütur
                const profileLinks = profileLinkTypes.map(linkType => {
                    const profileValue = userData[linkType] || "";
                    if (!profileValue) return null;
                    
                    let url = "";
                    let label = "";
                    let icon = "";
                    
                    switch (linkType) {
                        case "instagram": {
                            const instagramHandle = profileValue.replace(/^@?/, "");
                            url = `https://www.instagram.com/${instagramHandle}/`;
                            label = "Instagram";
                            icon = "üì∑";
                            break;
                        }
                        case "whatsapp": {
                            const whatsappNumber = profileValue.replace(/\D/g, "");
                            url = `https://wa.me/${whatsappNumber}`;
                            label = "WhatsApp";
                            icon = "üí¨";
                            break;
                        }
                        case "phone": {
                            const phoneNumber = profileValue.replace(/\D/g, "");
                            url = `tel:${phoneNumber}`;
                            label = "Telefon";
                            icon = "üìû";
                            break;
                        }
                        case "email":
                            url = `mailto:${profileValue}`;
                            label = "E-posta";
                            icon = "‚úâÔ∏è";
                            break;
                        case "iban": {
                            const accountName = userData.paymentAccountName || "";
                            const bankName = userData.bankName || "";
                            label = "√ñdeme Bilgileri (IBAN)";
                            icon = "üè¶";
                            return {url: null, label, icon, value: profileValue, accountName, bankName, isIban: true};
                        }
                    }
                    
                    return {url, label, icon, value: profileValue};
                }).filter(link => link !== null);
                
                // IBAN / √∂deme kartlarƒ± (tƒ±klanmaz, kopyalanabilir)
                const ibanLinks = profileLinks.filter(l => l.isIban);
                const otherLinks = profileLinks.filter(l => !l.isIban);
                
                if (otherLinks.length === 1 && ibanLinks.length === 0) {
                    // Sadece tek ileti≈üim linki varsa direkt y√∂nlendir
                    window.location.href = otherLinks[0].url;
                    return;
                }
                
                if (profileLinks.length > 0) {
                    let linksHtml = "";
                    otherLinks.forEach(link => {
                        linksHtml += `
                            <a href="${link.url}" style="background: rgba(255, 255, 255, 0.15); border-radius: 12px; padding: 20px; text-decoration: none; color: #fff; display: flex; align-items: center; gap: 16px; transition: all 0.3s ease; border: 1px solid rgba(255, 255, 255, 0.2);">
                                <span style="font-size: 32px;">${link.icon}</span>
                                <div style="flex: 1; text-align: left;">
                                    <div style="font-size: 18px; font-weight: 600; margin-bottom: 4px;">${link.label}</div>
                                    <div style="font-size: 14px; opacity: 0.8;">${link.value}</div>
                                </div>
                                <span style="font-size: 20px; opacity: 0.7;">‚Üí</span>
                            </a>
                        `;
                    });
                    ibanLinks.forEach(link => {
                        const ibanFormatted = (link.value || "").replace(/\s/g, " ");
                        linksHtml += `
                            <div class="iban-card" style="background: rgba(255, 255, 255, 0.15); border-radius: 12px; padding: 20px; color: #fff; border: 1px solid rgba(255, 255, 255, 0.2); text-align: left;">
                                <div style="display: flex; align-items: center; gap: 16px; margin-bottom: 12px;">
                                    <span style="font-size: 32px;">${link.icon}</span>
                                    <div style="font-size: 18px; font-weight: 600;">${link.label}</div>
                                </div>
                                ${link.accountName ? `<div style="font-size: 14px; opacity: 0.95; margin-bottom: 6px;"><strong>Ad Soyad:</strong> ${link.accountName}</div>` : ""}
                                ${link.bankName ? `<div style="font-size: 14px; opacity: 0.95; margin-bottom: 6px;"><strong>Banka:</strong> ${link.bankName}</div>` : ""}
                                <div style="font-size: 14px; opacity: 0.95; margin-bottom: 12px;"><strong>IBAN:</strong> <span class="iban-value">${ibanFormatted}</span></div>
                                <button type="button" class="copy-iban-btn" data-iban="${ibanFormatted.replace(/"/g, '&quot;')}" style="background: rgba(255,255,255,0.25); border: 1px solid rgba(255,255,255,0.4); color: #fff; padding: 10px 16px; border-radius: 8px; font-size: 14px; font-weight: 600; cursor: pointer;">IBAN\'ƒ± Kopyala</button>
                            </div>
                        `;
                    });
                    contentDiv.innerHTML = `
                        <h1 style="font-size: 28px; margin-bottom: 16px; font-weight: 700;">${ibanLinks.length && otherLinks.length ? "ƒ∞leti≈üim ve √ñdeme" : ibanLinks.length ? "√ñdeme Bilgileri" : "ƒ∞leti≈üim Bilgileri"}</h1>
                        <p style="font-size: 16px; line-height: 1.6; margin-bottom: 32px; opacity: 0.9;">${ibanLinks.length && otherLinks.length ? "ƒ∞leti≈üime ge√ßin veya √∂deme bilgilerini kopyalayƒ±n" : ibanLinks.length ? "Havale / EFT i√ßin a≈üaƒüƒ±daki bilgileri kullanabilirsiniz" : "ƒ∞leti≈üime ge√ßmek i√ßin bir se√ßenek se√ßin"}</p>
                        <div style="display: flex; flex-direction: column; gap: 16px;">
                            ${linksHtml}
                        </div>
                    `;
                    // IBAN kopyalama butonlarƒ±
                    contentDiv.querySelectorAll(".copy-iban-btn").forEach(btn => {
                        btn.addEventListener("click", function() {
                            const iban = (this.getAttribute("data-iban") || "").replace(/\s/g, "");
                            if (!iban) return;
                            navigator.clipboard.writeText(iban).then(function() {
                                const t = btn.textContent;
                                btn.textContent = "Kopyalandƒ±!";
                                btn.style.background = "rgba(76, 175, 80, 0.6)";
                                setTimeout(function() { btn.textContent = t; btn.style.background = ""; }, 2000);
                            });
                        });
                    });
                }
            } else {
                // Profil linki yoksa karakter sayfasƒ±na y√∂nlendir
                const characterId = tagData.characterId;
                if (characterId) {
                    window.location.href = `https://dahis.io/character/${characterId}`;
                    return;
                }
                
                // Fallback
                contentDiv.innerHTML = `
                    <div class="error">
                        <h2>Bilinmeyen Durum</h2>
                        <p>Tag bilgisi y√ºklenemedi.</p>
                        <a href="index.html" style="color: #fff; text-decoration: underline; margin-top: 20px; display: inline-block;">Ana Sayfaya D√∂n</a>
                    </div>
                `;
            }
        }
    </script>
</body>
</html>
